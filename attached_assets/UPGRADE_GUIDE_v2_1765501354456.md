# Shepherd Flow - 고도화 가이드 (v1.0 → v2.0)

> **전제**: v1.0 이미 개발 완료된 상태에서 진행
> **목적**: 교적 관리 중심으로 기능 추가/수정

---

## 📋 고도화 작업 목록

| Step | 작업 | 난이도 |
|------|------|--------|
| 1 | DB 스키마 추가 | 쉬움 |
| 2 | 메뉴 구조 변경 | 쉬움 |
| 3 | 학생 교적 카드 추가 | 중간 |
| 4 | 출석 체크 화면 분기 | 중간 |
| 5 | 장기결석자 관리 | 중간 |
| 6 | 대시보드 위젯 추가 | 쉬움 |
| 7 | 엑셀 다운로드 | 쉬움 |

---

## Step 1: DB 스키마 추가

### 추가할 테이블

```sql
-- 1. 학생 이력 테이블 (신규)
CREATE TABLE student_history (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  type VARCHAR(20) NOT NULL, -- mokjang_change, status_change, grade_change
  old_value JSONB,
  new_value JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. 장기결석자 심방 기록 테이블 (신규)
CREATE TABLE long_absence_contacts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  contact_date DATE NOT NULL,
  contact_method VARCHAR(20), -- phone, visit, message
  content TEXT,
  contacted_by UUID REFERENCES teachers(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_student_history_student ON student_history(student_id);
CREATE INDEX idx_long_absence_student ON long_absence_contacts(student_id);
```

### 기존 테이블 필드 추가

```sql
-- students 테이블에 필드 추가
ALTER TABLE students ADD COLUMN IF NOT EXISTS gender VARCHAR(1); -- M, F
ALTER TABLE students ADD COLUMN IF NOT EXISTS baptism VARCHAR(20) DEFAULT 'none'; -- infant, baptized, confirmed, none

-- teachers 테이블에 필드 추가  
ALTER TABLE teachers ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'active'; -- active, rest, resigned
```

### TypeScript 타입 추가 (types/database.ts)

```typescript
// 추가할 타입
export interface StudentHistory {
  id: string;
  student_id: string;
  type: 'mokjang_change' | 'status_change' | 'grade_change';
  old_value: any;
  new_value: any;
  created_at: string;
}

export interface LongAbsenceContact {
  id: string;
  student_id: string;
  contact_date: string;
  contact_method: 'phone' | 'visit' | 'message';
  content: string;
  contacted_by: string;
  created_at: string;
}

// 기존 Student 타입에 추가
export interface Student {
  // ... 기존 필드들
  gender?: 'M' | 'F';
  baptism?: 'infant' | 'baptized' | 'confirmed' | 'none';
}

// 기존 Teacher 타입에 추가
export interface Teacher {
  // ... 기존 필드들
  status?: 'active' | 'rest' | 'resigned';
}
```

### 완료 기준
- [ ] 테이블 2개 추가됨
- [ ] 기존 테이블 필드 추가됨
- [ ] TypeScript 타입 업데이트됨

---

## Step 2: 메뉴 구조 변경

### 변경 내용

**관리자 메뉴** (sidebar.tsx 수정)
```
변경 전:
📊 대시보드
👥 학생 관리
🧑‍🏫 교사 관리  
🏠 목장 관리
📋 출석 체크
📝 목장 보고서  ← 삭제
⚙️ 설정

변경 후:
📊 대시보드
👥 학생 관리
🧑‍🏫 교사 관리
🏠 목장 관리
📋 출석 체크
⚠️ 장기결석자    ← 추가
📈 통계/리포트   ← 추가
⚙️ 설정
```

**교사 메뉴** (sidebar.tsx 수정)
```
변경 전:
📊 대시보드
📋 출석 체크
📝 목장 보고서  ← 삭제

변경 후:
📊 대시보드
👥 내 목장 학생  ← 추가
📋 출석 체크
```

### 수정할 파일
- `components/layout/sidebar.tsx`
- `components/layout/mobile-nav.tsx`

### 삭제할 파일/폴더
- `app/(dashboard)/reports/` 폴더 전체
- `components/reports/` 폴더 전체
- `app/actions/reports.ts`

### 추가할 라우트
- `/long-absence` - 장기결석자 관리
- `/stats` - 통계/리포트

### 완료 기준
- [ ] 메뉴에서 "목장 보고서" 삭제됨
- [ ] 메뉴에 "장기결석자", "통계/리포트" 추가됨
- [ ] 교사 메뉴에 "내 목장 학생" 추가됨
- [ ] reports 관련 파일 삭제됨

---

## Step 3: 학생 교적 카드 추가

### 추가할 기능

학생 목록에서 학생 클릭 시 **상세 교적 카드** Sheet 열림

```
┌─────────────────────────────────────────┐
│  👤 홍길동                    [수정] [X] │
│  중2 | 남 | 한빛중학교                   │
├─────────────────────────────────────────┤
│  📱 010-1234-5678                       │
│  👨‍👩‍👧 김영희 (모) 010-9876-5432           │
│  🏠 1목장 (김사랑 교사)                  │
│  ⛪ 세례: 유아세례                       │
│  📅 등록일: 2023.03.05                  │
├─────────────────────────────────────────┤
│  📊 출석률: 85% (최근 3개월)             │
│                                         │
│  최근 출석 기록                          │
│  • 1/12 ✅ 출석                         │
│  • 1/5  ✅ 출석                         │
│  • 12/29 🔵 사유결석 (가족여행)          │
│  • 12/22 ✅ 출석                        │
│  • 12/15 🔴 결석                        │
│                        [전체 보기 →]    │
├─────────────────────────────────────────┤
│  📝 이력                                │
│  • 2024.03 1목장 배정 (신규등록)         │
│  • 2024.03 중1 → 중2 승급               │
├─────────────────────────────────────────┤
│  💬 메모                                │
│  "수학 과외 때문에 가끔 지각"            │
│                            [메모 추가]  │
└─────────────────────────────────────────┘
```

### 추가할 파일
- `components/students/student-detail-sheet.tsx`

### 수정할 파일
- `components/students/student-list.tsx` - 클릭 시 Sheet 열기
- `app/actions/students.ts` - getStudentDetail(), getStudentHistory() 추가

### 추가할 Server Actions

```typescript
// 학생 상세 정보 + 최근 출석
async function getStudentDetail(studentId: string)

// 학생 이력 조회
async function getStudentHistory(studentId: string)

// 학생 메모 추가
async function addStudentMemo(studentId: string, memo: string)
```

### 완료 기준
- [ ] 학생 클릭 시 상세 Sheet 열림
- [ ] 출석 히스토리 표시됨
- [ ] 출석률 계산되어 표시됨
- [ ] 이력 표시됨

---

## Step 4: 출석 체크 화면 분기

### 현재 상태 (v1.0)
- 교사만 담당 목장 출석 체크 가능

### 변경 내용
- **관리자**: 전체 목장 한 화면에서 출석 체크
- **교사**: 담당 목장만 출석 체크 (기존 유지)

### 수정할 파일
- `app/(dashboard)/attendance/page.tsx` - 역할별 분기 처리

### 추가할 컴포넌트
- `components/attendance/admin-attendance.tsx` - 관리자용 전체 출석

### 관리자용 전체 출석 화면

```
┌─────────────────────────────────────────────────────────────┐
│  📅 2025년 1월 12일 (주일)              [< 이전주] [다음주 >]│
├─────────────────────────────────────────────────────────────┤
│  📊 현황: 45/52명 출석 (86.5%)                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🏠 1목장 (김사랑) - 8/10명           [전체출석] [전체결석]  │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                   │
│  │ ✅  │ │ ✅  │ │ 🔴  │ │ ✅  │ │ ✅  │ ...               │
│  │홍길동│ │김철수│ │이영희│ │박민수│ │최지은│                │
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                   │
│                                                             │
│  🏠 2목장 (이은혜) - 7/8명            [전체출석] [전체결석]  │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                           │
│  │ ✅  │ │ ✅  │ │ ✅  │ │ 🔴  │ ...                       │
│  │김하은│ │박서준│ │이지민│ │한소희│                        │
│  └─────┘ └─────┘ └─────┘ └─────┘                           │
│                                                             │
│                                      [💾 전체 저장하기]     │
└─────────────────────────────────────────────────────────────┘
```

### 로직 분기

```typescript
// attendance/page.tsx
export default function AttendancePage() {
  const { isAdmin } = useAuth();
  
  return isAdmin ? <AdminAttendance /> : <TeacherAttendance />;
}
```

### 완료 기준
- [ ] 관리자 로그인 시 전체 출석 화면 표시
- [ ] 교사 로그인 시 담당 목장만 표시 (기존)
- [ ] 관리자 전체 출석 저장 작동

---

## Step 5: 장기결석자 관리

### 추가할 페이지
`app/(dashboard)/long-absence/page.tsx`

### 화면 구성

```
┌─────────────────────────────────────────────────────────────┐
│  ⚠️ 장기결석자 관리                                         │
├─────────────────────────────────────────────────────────────┤
│  🔴 4주 이상 (2명)                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 이영희 (1목장) | 중1 | 5주 결석                      │   │
│  │ 마지막 출석: 12/8 | 📞 010-1234-5678                │   │
│  │ [심방 기록] [휴식 전환] [상세보기]                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 한소희 (2목장) | 고1 | 4주 결석                      │   │
│  │ 마지막 출석: 12/15 | 📞 010-5678-1234               │   │
│  │ [심방 기록] [휴식 전환] [상세보기]                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  🟡 2주 이상 (3명)                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 박민수 (1목장) | 중2 | 2주 결석                      │   │
│  │ ...                                                  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 심방 기록 Dialog

```
┌─────────────────────────────────────┐
│  📞 심방 기록 - 이영희               │
├─────────────────────────────────────┤
│  연락 일자: [2025-01-10]            │
│  연락 방법: ○ 전화  ○ 방문  ○ 문자  │
│  내용:                              │
│  ┌─────────────────────────────┐   │
│  │ 어머니 통화함.               │   │
│  │ 학원 시간이 겹쳐서 못 온다고. │   │
│  │ 2월부터 다시 나올 예정.      │   │
│  └─────────────────────────────┘   │
│              [취소] [저장]          │
└─────────────────────────────────────┘
```

### 추가할 Server Actions

```typescript
// 장기결석자 목록 조회 (2주 이상 연속 결석)
async function getLongAbsenceStudents()

// 심방 기록 저장
async function saveLongAbsenceContact(data: {
  student_id: string;
  contact_date: string;
  contact_method: string;
  content: string;
})

// 심방 기록 조회
async function getLongAbsenceContacts(studentId: string)
```

### 장기결석 판정 로직

```typescript
// 최근 N주간 출석 기록 확인
// 연속 결석 주 수 계산
// 2주 이상이면 장기결석자로 분류
```

### 완료 기준
- [ ] 장기결석자 자동 감지됨
- [ ] 2주/4주 구분하여 표시됨
- [ ] 심방 기록 저장/조회 작동
- [ ] "휴식 전환" 클릭 시 상태 변경됨

---

## Step 6: 대시보드 위젯 추가

### 현재 상태 (v1.0)
- 기본 출석률, 차트 있음

### 추가할 위젯

1. **장기결석자 알림 카드**
```
⚠️ 장기결석자 알림
• 이영희 (1목장) - 5주 결석
• 한소희 (2목장) - 4주 결석
           [관리하기 →]
```

2. **이번 주 생일 카드**
```
🎂 이번 주 생일
• 1/14 (화) 김철수 (중2)
• 1/16 (목) 송혜교 (고2)
```

3. **미배정 학생 알림** (있을 경우)
```
📌 미배정 학생 3명
           [배정하기 →]
```

### 수정할 파일
- `app/(dashboard)/page.tsx`
- `components/dashboard/` 폴더에 위젯 컴포넌트 추가

### 추가할 Server Actions

```typescript
// 이번 주 생일자 조회
async function getUpcomingBirthdays()

// 미배정 학생 수 조회
async function getUnassignedStudentCount()
```

### 완료 기준
- [ ] 장기결석자 알림 위젯 표시됨
- [ ] 생일 위젯 표시됨
- [ ] 위젯 클릭 시 해당 페이지로 이동

---

## Step 7: 엑셀 다운로드

### 추가할 페이지
`app/(dashboard)/stats/page.tsx`

### 화면 구성

```
┌─────────────────────────────────────────────────────────────┐
│  📈 통계 / 리포트                                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📊 출석 통계                                               │
│  기간: [2025.01] ~ [2025.01]  [조회]                       │
│                                                             │
│  [출석률 차트 영역]                                         │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📥 엑셀 다운로드                                           │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 📋 학생명단 │ │ 📋 교사명단 │ │ 📋 출석데이터│          │
│  │   (교적부)  │ │             │ │  기간 선택  │          │
│  │  [다운로드] │ │  [다운로드] │ │  [다운로드] │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### xlsx 라이브러리 설치

```bash
npm install xlsx
```

### 추가할 Server Actions / API Routes

```typescript
// 학생 명단 엑셀 데이터
async function exportStudentsToExcel()

// 교사 명단 엑셀 데이터  
async function exportTeachersToExcel()

// 출석 데이터 엑셀
async function exportAttendanceToExcel(startDate: string, endDate: string)
```

### 엑셀 생성 유틸리티

```typescript
// lib/excel.ts
import * as XLSX from 'xlsx';

export function generateExcel(data: any[], filename: string) {
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
  XLSX.writeFile(wb, `${filename}.xlsx`);
}
```

### 학생 명단 엑셀 컬럼
```
이름, 학년, 성별, 생년월일, 학교, 연락처, 
보호자명, 보호자연락처, 목장, 담당교사, 
세례여부, 등록일, 상태
```

### 완료 기준
- [ ] 통계 페이지 표시됨
- [ ] 학생 명단 엑셀 다운로드 작동
- [ ] 교사 명단 엑셀 다운로드 작동
- [ ] 출석 데이터 엑셀 다운로드 작동

---

## 🚀 Agent 사용법

### 프롬프트

```
[PRD v2.0 전체 붙여넣기]

---

[이 고도화 가이드 전체 붙여넣기]

---

현재 v1.0이 개발 완료된 상태야.
위 PRD와 고도화 가이드를 참고해서 Step 1부터 순서대로 진행해줘.

기존 코드는 수정/추가만 하고, 새로 만들 필요 없어.
각 Step 완료되면 알려줘.
```

---

## 체크리스트 요약

- [ ] **Step 1**: DB 테이블 2개 추가, 필드 추가
- [ ] **Step 2**: 메뉴에서 보고서 삭제, 장기결석자/통계 추가
- [ ] **Step 3**: 학생 상세 교적 카드 Sheet 추가
- [ ] **Step 4**: 관리자용 전체 출석 체크 화면 추가
- [ ] **Step 5**: 장기결석자 관리 페이지 추가
- [ ] **Step 6**: 대시보드에 위젯 추가
- [ ] **Step 7**: 통계 페이지 + 엑셀 다운로드 추가

---

**문서 버전**: 2.0 (고도화)
